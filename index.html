<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>KALEIDOSCOPE - ãƒ“ãƒ¼ç‰ä¸‡è¯é¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { 
  margin:0;
  height:100vh;
  background:#fff;
  transition:background-color 2.5s ease;
  overflow:hidden;
  font-family:sans-serif;
}
canvas{
  position:absolute;
  inset:0;
}
#controls{
  position:fixed;
  bottom:15px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  padding:12px 16px;
  background:rgba(0,0,0,.65);
  border-radius:10px;
  max-width:95vw;
  z-index:10;
}
label{
  font-size:11px;
  color:#fff;
  display:flex;
  flex-direction:column;
  gap:4px;
}
button{
  padding:6px 10px;
  font-size:12px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="imageLoader" accept="image/*" multiple>
  <label>Slices
    <input type="range" id="sliceRange" min="0" max="24" value="12">
  </label>
  <button id="gyroBtn">ğŸŒ€ ã‚¸ãƒ£ã‚¤ãƒ­ON</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const imageLoader = document.getElementById("imageLoader");
const sliceRange = document.getElementById("sliceRange");
const gyroBtn = document.getElementById("gyroBtn");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

let images=[], idx=0, fade=1;
let angle=0;
let gyroX=0, gyroY=0;
let gyroEnabled=false;
let palette=[], timer;

// ===== ã‚¸ãƒ£ã‚¤ãƒ­è¨±å¯ =====
gyroBtn.onclick = async ()=>{
  if(typeof DeviceOrientationEvent?.requestPermission === "function"){
    const res = await DeviceOrientationEvent.requestPermission();
    if(res!=="granted") return;
  }
  gyroEnabled=true;
  gyroBtn.textContent="ğŸŒ€ ã‚¸ãƒ£ã‚¤ãƒ­ONâœ”";
};

addEventListener("deviceorientation",e=>{
  if(!gyroEnabled) return;
  gyroX=e.gamma||0;
  gyroY=e.beta||0;
});

// ===== ç”»åƒãƒ­ãƒ¼ãƒ‰ =====
imageLoader.onchange=()=>{
  images=[];
  idx=0;
  for(const f of imageLoader.files){
    const img=new Image();
    img.src=URL.createObjectURL(f);
    img.onload=()=>{
      makePalette(img);
      startBg();
    };
    images.push(img);
  }
};

// ===== å´é¢ã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿ =====
addEventListener("devicemotion",e=>{
  if(!images.length) return;
  const a=e.accelerationIncludingGravity;
  if(!a) return;
  if(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z)>30){
    idx=(idx+1)%images.length;
    fade=0;
    makePalette(images[idx]);
  }
});

// ===== èƒŒæ™¯è‰² =====
function makePalette(img){
  const c=document.createElement("canvas");
  const x=c.getContext("2d");
  c.width=c.height=40;
  x.drawImage(img,0,0,40,40);
  const d=x.getImageData(0,0,40,40).data;
  const m={};
  for(let i=0;i<d.length;i+=40){
    const h=((d[i]<<16)|(d[i+1]<<8)|d[i+2]).toString(16).padStart(6,"0");
    m[h]=(m[h]||0)+1;
  }
  palette=Object.keys(m)
    .sort((a,b)=>m[b]-m[a])
    .slice(0,4)
    .map(h=>`#${h}`);
}
function startBg(){
  clearInterval(timer);
  timer=setInterval(()=>{
    if(palette.length)
      document.body.style.backgroundColor =
        palette[Math.random()*palette.length|0];
  },3000);
}

// ===== æç”» =====
function draw(){
  requestAnimationFrame(draw);
  if(!images.length) return;

  const img=images[idx];
  angle += gyroX * 0.002; // â† ã‚¸ãƒ£ã‚¤ãƒ­ã®ã¿ã§å›è»¢

  const w=canvas.width,h=canvas.height;
  const cx=w/2,cy=h/2;
  const r=Math.min(w,h)*0.48;

  fade=Math.min(1,fade+0.05);
  ctx.globalAlpha=fade;
  ctx.clearRect(0,0,w,h);

  ctx.save();
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.clip();

  const s=Math.max(r*2/img.width,r*2/img.height)*1.4;
  const iw=img.width*s, ih=img.height*s;
  const mx=gyroX*3, my=gyroY*3;

  const n=+sliceRange.value;
  if(n===0){
    ctx.translate(cx,cy);
    ctx.rotate(angle);
    ctx.drawImage(img,-iw/2+mx,-ih/2+my,iw,ih);
  }else{
    const a2=Math.PI*2/n;
    for(let i=0;i<n;i++){
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(i*a2+angle);
      ctx.beginPath();
      const w2=r*1.8,h2=Math.tan(a2/2)*w2;
      ctx.moveTo(0,0);
      ctx.lineTo(w2,-h2);
      ctx.lineTo(w2,h2);
      ctx.closePath();
      ctx.clip();
      if(i%2) ctx.scale(-1,1);
      ctx.drawImage(img,-iw/2+mx,-ih/2+my,iw,ih);
      ctx.restore();
    }
  }
  ctx.restore();
  ctx.globalAlpha=1;
}
requestAnimationFrame(draw);
</script>
</body>
</html>
